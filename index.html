<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compilazione allegati – Centri UniPA</title>

  <!-- pdf-lib (merge + create PDF in-browser) -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    :root{
      --bg: #0b0f17;
      --panel: #111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#263244;
      --accent:#60a5fa;
      --accent2:#22c55e;
      --danger:#ef4444;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --field:#0b1220;
      --chip:#101a2c;
      --link:#93c5fd;
      --focus: rgba(96,165,250,.35);
      --brand: #1d4ed8;
    }
    [data-theme="light"]{
      --bg:#f6f8fb;
      --panel:#ffffff;
      --panel2:#f1f5f9;
      --text:#0f172a;
      --muted:#475569;
      --border:#d7dee7;
      --accent:#0b4fa3;
      --accent2:#0f766e;
      --danger:#b42318;
      --shadow: 0 10px 26px rgba(2,6,23,.10);
      --radius: 16px;
      --field:#ffffff;
      --chip:#eef2ff;
      --link:#0b4fa3;
      --focus: rgba(11,79,163,.20);
      --brand:#0b4fa3;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.20), transparent 55%),
                  radial-gradient(900px 500px at 90% 0%, rgba(34,197,94,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background: color-mix(in srgb, var(--bg) 80%, transparent);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px 18px;}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .title{
      display:flex; gap:12px; align-items:flex-start;
    }
    .badge{
      width:40px; height:40px; border-radius:12px;
      background: linear-gradient(135deg, var(--accent), color-mix(in srgb, var(--accent2) 55%, var(--accent) 45%));
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      color:white; font-weight:800;
    }
    h1{font-size:18px; margin:0; letter-spacing:.2px}
    .subtitle{font-size:13px; color:var(--muted); margin-top:4px; line-height:1.35}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button{
      border:1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--panel) 85%, transparent), var(--panel2));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.15);
      font-weight:600;
      font-size:13px;
    }
    button:hover{border-color: color-mix(in srgb, var(--border) 55%, var(--accent) 45%);}
    button:focus{outline:2px solid var(--focus); outline-offset:2px;}
    .btn-primary{
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border) 45%);
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 35%, var(--panel) 65%), var(--panel2));
    }
    .btn-good{
      border-color: color-mix(in srgb, var(--accent2) 55%, var(--border) 45%);
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent2) 22%, var(--panel) 78%), var(--panel2));
    }
    .btn-danger{
      border-color: color-mix(in srgb, var(--danger) 55%, var(--border) 45%);
      background: linear-gradient(180deg, color-mix(in srgb, var(--danger) 20%, var(--panel) 80%), var(--panel2));
    }

    /* Layout a colonna singola (Guida rapida rimossa) */
    main .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      padding:16px 18px 26px;
      max-width:1100px;
      margin:0 auto;
    }

    .card{
      background: linear-gradient(180deg, color-mix(in srgb, var(--panel) 94%, transparent), var(--panel2));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .card-h h2{
      font-size:14px; margin:0; letter-spacing:.2px;
    }
    .card-h p{
      margin:6px 0 0;
      font-size:12px; color:var(--muted); line-height:1.35;
    }
    .card-b{padding:14px;}
    .row{display:grid; grid-template-columns: 220px 1fr; gap:10px; align-items:start; margin:10px 0;}
    @media (max-width: 700px){ .row{grid-template-columns:1fr} }

    label{font-size:12px; color:var(--muted); display:block; padding-top:8px;}
    select, input[type="text"], input[type="number"], input[type="date"], textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: var(--field);
      color: var(--text);
      font-size:13px;
    }
    textarea{min-height:92px; resize:vertical;}
    input:focus, select:focus, textarea:focus{outline:2px solid var(--focus); outline-offset:2px;}
    .hint{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35;}
    .hr{height:1px; background:var(--border); margin:14px 0;}

    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      padding:6px 10px;
      border:1px solid var(--border);
      background: var(--chip);
      border-radius: 999px;
      font-size:12px;
      color: color-mix(in srgb, var(--text) 86%, var(--muted) 14%);
    }
    .chip strong{color:var(--text)}
    .status{
      font-size:12px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel2) 70%, transparent);
      color: var(--muted);
    }
    .status.ok{border-color: color-mix(in srgb, var(--accent2) 55%, var(--border) 45%); color: color-mix(in srgb, var(--accent2) 65%, var(--text) 35%);}
    .status.err{border-color: color-mix(in srgb, var(--danger) 55%, var(--border) 45%); color: color-mix(in srgb, var(--danger) 65%, var(--text) 35%);}

    .filebox{
      border:1px dashed color-mix(in srgb, var(--border) 70%, var(--muted) 30%);
      background: color-mix(in srgb, var(--panel2) 70%, transparent);
      border-radius: 14px;
      padding:12px;
    }
    .filebox input[type="file"]{width:100%}
    .small{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.35;}
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    .section-title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin:4px 0 10px;
    }
    .section-title h3{margin:0; font-size:13px;}
    .req{font-size:11px; color:var(--muted);}
    .warn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid color-mix(in srgb, var(--danger) 40%, var(--border) 60%);
      background: color-mix(in srgb, var(--danger) 10%, transparent);
      color: color-mix(in srgb, var(--text) 88%, var(--danger) 12%);
      font-size:12px;
      line-height:1.35;
    }
  </style>
</head>

<body data-theme="light">
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <div class="badge">U</div>
        <div>
          <h1>Compilazione allegati</h1>
          <div class="subtitle">
            Seleziona la tipologia di Centro e l’Allegato. I campi si adattano automaticamente.
            Al termine, genera un unico PDF che include il riepilogo dei dati e tutte le PDF caricate (pagine accodate).
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="btnTheme" type="button" class="btn-primary" title="Cambia tema">Tema: Scuro</button>
        <button id="btnSave" type="button">Salva bozza</button>
        <button id="btnLoad" type="button">Recupera bozza</button>
        <button id="btnClear" type="button" class="btn-danger">Svuota</button>
        <button id="btnPDF" type="button" class="btn-good">Genera PDF</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="card-h">
        <div>
          <h2>1. Selezione</h2>
          <p>La selezione del tipo di Centro determina automaticamente gli Allegati disponibili.</p>
        </div>
        <div class="status" id="statusBox">In attesa di selezioni…</div>
      </div>

      <div class="card-b">
        <div class="row">
          <label for="tipoCentro">Tipo di centro</label>
          <div>
            <select id="tipoCentro">
              <option value="">— Seleziona —</option>
              <option value="interuniversitario">Centro Interuniversitario</option>
              <option value="interdipartimentale">Centro Interdipartimentale</option>
              <option value="servizi">Centro di Servizi</option>
              <option value="ateneo">Centro di Ateneo</option>
            </select>
            <div class="hint">Questa scelta filtra l’elenco degli Allegati (A–N).</div>
          </div>
        </div>

        <div class="row">
          <label for="allegato">Allegato</label>
          <div>
            <select id="allegato" disabled>
              <option value="">— Seleziona prima il tipo di centro —</option>
            </select>
            <div class="hint" id="allegatoHint">Seleziona un Allegato per visualizzare i campi.</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="section-title">
          <h3>2. Dati generali</h3>
          <div class="req">Consigliato</div>
        </div>

        <div class="row">
          <label for="protocollo">Referente per il Centro</label>
          <div>
            <input id="protocollo" type="text" placeholder="Nominativo e ruolo" />
            <div class="hint">Facoltativo: utile per rintracciare la pratica.</div>
          </div>
        </div>

        <div class="row">
          <label for="dataCompilazione">Data compilazione</label>
          <div>
            <input id="dataCompilazione" type="date" />
          </div>
        </div>

        <div class="row">
          <label for="noteGenerali">Note generali</label>
          <div>
            <textarea id="noteGenerali" placeholder="Eventuali note per l’istruttoria…"></textarea>
          </div>
        </div>

        <div class="hr"></div>

        <div class="section-title">
          <h3>3. Informazioni pratica</h3>
          <div class="req">Obbligatorio</div>
        </div>

        <div id="dynamicFields" class="hint">
          Seleziona un Allegato per iniziare la compilazione.
        </div>

        <div class="hr"></div>

        <div class="section-title">
          <h3>4. Allegati PDF</h3>
          <div class="req">Più file (accodabili)</div>
        </div>

        <div class="filebox">
          <div class="hint" style="margin:0 0 10px;">
            Puoi aggiungere più PDF anche in momenti diversi. I file verranno accodati nel PDF finale nell’ordine mostrato.
          </div>

          <div id="requiredPdfInfo" class="warn" style="display:none; margin:0 0 10px;">
            <strong>Per l’Allegato A sono obbligatori almeno 2 PDF:</strong><br>
            • Bozza della convenzione ai sensi dell'Art. 8 del Regolamento sui Centri<br>
            • Estratto verbale/i Consiglio/i di Dipartimento ai sensi dell'Art. 4 comma 2 lettera g del Regolamento sui Centri
          </div>


          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
            <button id="btnAddFiles" type="button" class="btn-primary">Aggiungi PDF</button>
            <button id="btnClearFiles" type="button" class="btn-danger">Svuota allegati</button>
          </div>

          <input id="fileUploads" type="file" accept="application/pdf" multiple style="display:none" />

          <div class="small" id="fileList">Nessun file caricato.</div>
          <div class="small">Nota: sono accettati esclusivamente file PDF.</div>
        </div>

        <div class="hr"></div>

        <div class="section-title">
          <h3>5. Riepilogo</h3>
          <div class="req">Automatico</div>
        </div>

        <div class="chips" id="summaryChips">
          <div class="chip"><strong>Centro:</strong> —</div>
          <div class="chip"><strong>Allegato:</strong> —</div>
        </div>

        <div class="hr"></div>

        <div class="section-title">
          <h3>6. Invio Allegati</h3>
          <div class="req">Informativo</div>
        </div>
        <div class="warn">
          il file PDF generato va inviato ..........
        </div>

      </div>
    </section>
  </div>
</main>

<script>
const ALLEGATI = {
  A: { key:"A", centro:"interuniversitario", title:"Allegato A – CAPO I ART. 4 – Proposta di istituzione di un Centro Interuniversitario",
    fields: [
      { id:"denominazione", label:"Denominazione del Centro Interuniversitario", type:"text", required:true },
      { id:"durata", label:"Durata (anni) – min 3 max 6", type:"number", min:3, max:6, required:true },
      { id:"missione_obiettivi", label:"Missione e obiettivi del Centro", type:"textarea", required:true },
      { id:"indicatori_monitoraggio", label:"Indicatori di monitoraggio", type:"textarea", required:true },
      { id:"ambiti_attivita", label:"Ambiti di attività previsti in temi di ricerca, riferimento tecnologico e Terza missione", type:"textarea", required:true },
      { id:"programma", label:"Programma delle attività per il periodo individuato", type:"textarea", required:true },
            { id:"atenei_aderenti", label:"Elenco degli Atenei che intendono aderire", type:"textarea", required:true },
            { id:"pianificazione_sito", label:"Pianificazione del sito web del Centro Interuniversitario", type:"textarea", required:true },
    ]
  },
  B: { key:"B", centro:"interuniversitario", title:"Allegato B – CAPO I ART. 5 – Proposta di adesione ad un Centro Interuniversitario di altri Atenei",
    fields: [
      { id:"bozza_convenzione", label:"Bozza della Convenzione – descrizione / riferimento file", type:"textarea", required:true },
      { id:"verbali", label:"Estratto verbale/i Consiglio/i di Dipartimento (adesione + docenti referenti) – estremi", type:"textarea", required:true },
    ]
  },
  C: { key:"C", centro:"interuniversitario", title:"Allegato C – CAPO I ART. 6 – Istanza di rinnovo di un Centro Interuniversitario",
    fields: [
      { id:"durata", label:"Durata rinnovo (anni) – min 3 max 6", type:"number", min:3, max:6, required:true },      { id:"delibere_atenei", label:"Elenco degli Atenei che intendono rinnovare l'adesione", type:"textarea", required:true },    ]
  },
  E: { key:"E", centro:"interdipartimentale", title:"Allegato E – CAPO II ART. 13 – Proposta di istituzione di un Centro Interdipartimentale",
    fields: [
      { id:"denominazione", label:"Denominazione del Centro Interdipartimentale", type:"text", required:true },
      { id:"durata", label:"Durata (anni) – min 3 max 6", type:"number", min:3, max:6, required:true },

      { id:"missione", label:"Missione e obiettivi del Centro", type:"textarea", required:true },
      { id:"indicatori_monitoraggio", label:"Indicatori di monitoraggio", type:"textarea", required:true },
      { id:"ambiti_attivita", label:"Ambiti di attività previsti in temi di ricerca, riferimento tecnologico e Terza missione", type:"textarea", required:true },

      { id:"docenti_afferenti", label:"Elenco nominativo docenti afferenti (almeno 2 Dipartimenti)", type:"textarea", required:true },
      { id:"dip_sede", label:"Dipartimento sede amministrativa", type:"textarea", required:true },
      { id:"pianificazione_sito", label:"Pianificazione del sito web del Centro Interdipartimentale", type:"textarea", required:true },
    ]
  },
  F: { key:"F", centro:"interdipartimentale", title:"Allegato F – CAPO II ART. 14 – Istanza di rinnovo di un Centro Interdipartimentale",
    fields: [
      { id:"attivita", label:"Descrizione attività da svolgere e svolte nel periodo precedente", type:"textarea", required:true },
      { id:"risultati", label:"Risultati delle attività svolte", type:"textarea", required:true },
      { id:"finanziamenti", label:"Eventuali finanziamenti ricevuti", type:"textarea", required:false },
      { id:"avanzamento", label:"Stato di avanzamento dei progetti", type:"textarea", required:true },      { id:"dip_gestione", label:"Dipartimento che assume la gestione amministrativa", type:"textarea", required:true },
    ]
  },
  H: { key:"H", centro:"servizi", title:"Allegato H – CAPO III ART. 24 – Proposta di istituzione di un Centro di Servizi",
    fields: [
      { id:"denominazione", label:"Denominazione", type:"text", required:true },
      { id:"missione", label:"Missione, obiettivi, indicatori di monitoraggio e ambiti", type:"textarea", required:true },
      { id:"programma_catalogo", label:"Programma attività e catalogo eventuali servizi offerti", type:"textarea", required:true },
      { id:"autonomia", label:"Ragioni per attribuzione autonomia economico-gestionale (art. 23, c.2)", type:"textarea", required:true },
      { id:"risorse_esterne", label:"Previsione acquisizione risorse esterne (stima primi 3 anni)", type:"textarea", required:true },
      { id:"pianificazione_sito", label:"Pianificazione del sito web", type:"textarea", required:true },
      { id:"bozza_regolamento", label:"Bozza regolamento di funzionamento – descrizione / riferimento file", type:"textarea", required:true },
    ]
  },
  L: { key:"L", centro:"ateneo", title:"Allegato L – CAPO IV ART. 36 – Proposta di istituzione di un Centro di Ateneo",
    fields: [
      { id:"denominazione", label:"Denominazione", type:"text", required:true },
      { id:"missione", label:"Missione, obiettivi, indicatori di monitoraggio e ambiti", type:"textarea", required:true },
      { id:"programma_catalogo", label:"Programma attività e catalogo eventuali servizi offerti", type:"textarea", required:true },
      { id:"pianificazione_sito", label:"Pianificazione del sito web", type:"textarea", required:true },
      { id:"bozza_regolamento", label:"Bozza regolamento di funzionamento – descrizione / riferimento file", type:"textarea", required:true },
    ]
  },
};

const CENTRI = {
  interuniversitario: { label:"Centro Interuniversitario", allegati:["A","B","C"] },
  interdipartimentale: { label:"Centro Interdipartimentale", allegati:["E","F"] },
  servizi: { label:"Centro di Servizi", allegati:["H"] },
  ateneo: { label:"Centro di Ateneo", allegati:["L"] },
};


const PDF_REQUIREMENTS = {
  A: {
    min: 2,
    items: [
      "Bozza della convenzione ai sensi dell'Art. 8 del Regolamento sui Centri",
      "Estratto verbale/i Consiglio/i di Dipartimento ai sensi dell'Art. 4 comma 2 lettera g del Regolamento sui Centri"
    ]
  },
  B: {
    min: 2,
    items: [
      "Bozza della Convenzione ai sensi dell'art. 5 del Regolamento",
      "Estratto del verbale del Consiglio di Dipartimento dei Dipartimenti coinvolti"
    ]
  },
  C: {
    min: 4,
    items: [
      "Atto di Rinnovo della Convenzione",
      "Riepilogo, anche in forma di relazione, delle attività svolte nel precedente periodo di rinnovo: risultati delle attività svolte /eventuali finanziamenti ricevuti/stato di avanzamento dei progetti",
      "Programma delle attività previste per il periodo di rinnovo",
      "Estratto del verbale del Consiglio di Dipartimento dei Dipartimenti coinvolti presso Unipa"
    ]
  },
  E: {
    min: 4,
    items: [
      "Programma, anche in forma di relazione, delle attività previste per il periodo individuato",
      "Estratto verbale/i Consiglio/i di Dipartimento ai sensi dell'art. 13 comma 2 lettera f",
      "Delibera del Consiglio di Dipartimento di accettazione della sede amministrativa",
      "Bozza del Regolamento di funzionamento ai sensi dell'art. 18 del Regolamento sui Centri"
    ]
  }
};




const el = (id)=>document.getElementById(id);

const tipoCentroEl = el("tipoCentro");
const allegatoEl = el("allegato");
const dynEl = el("dynamicFields");
const statusBox = el("statusBox");

const fileUploads = el("fileUploads");
const fileList = el("fileList");
const btnAddFiles = el("btnAddFiles");
const btnClearFiles = el("btnClearFiles");
const requiredPdfInfo = el("requiredPdfInfo");
// --- Riferimenti sezioni (per ALLEGATO B: rimozione "Campi Allegato" e rinumerazione) ---
const campiTitleH3 = [...document.querySelectorAll(".section-title h3")]
  .find(h => h.textContent.trim().includes("Informazioni pratica"));
const campiSectionTitle = campiTitleH3 ? campiTitleH3.closest(".section-title") : null;
const campiSectionDyn = dynEl; // contenuto dinamico
const hrBeforeCampi = campiSectionTitle ? campiSectionTitle.previousElementSibling : null; // dovrebbe essere .hr
const hrAfterCampi = campiSectionDyn ? campiSectionDyn.nextElementSibling : null; // dovrebbe essere .hr

const pdfTitleH3 = [...document.querySelectorAll(".section-title h3")]
  .find(h => h.textContent.trim().includes("Allegati PDF"));
const riepilogoTitleH3 = [...document.querySelectorAll(".section-title h3")]
  .find(h => h.textContent.trim().includes("Riepilogo"));
const invioTitleH3 = [...document.querySelectorAll(".section-title h3")]
  .find(h => h.textContent.trim().includes("Invio Allegati"));

function applySectionLayoutForAllegato(){
  const aKey = allegatoEl.value;
  const isB = (aKey === "B");

  // Nascondi/mostra sezione "Informazioni pratica" SOLO per B
  const disp = isB ? "none" : "";

  if(campiSectionTitle) campiSectionTitle.style.display = disp;
  if(campiSectionDyn) campiSectionDyn.style.display = disp;

  // gestione linee di separazione:
  // - per B teniamo visibile la linea prima di "Allegati PDF"
  // - nascondiamo solo quella subito dopo la sezione nascosta
  if(isB){
    if(hrBeforeCampi && hrBeforeCampi.classList?.contains("hr"))
      hrBeforeCampi.style.display = "";   // mantiene la separazione
    if(hrAfterCampi && hrAfterCampi.classList?.contains("hr"))
      hrAfterCampi.style.display = "none";
  }else{
    if(hrBeforeCampi && hrBeforeCampi.classList?.contains("hr"))
      hrBeforeCampi.style.display = "";
    if(hrAfterCampi && hrAfterCampi.classList?.contains("hr"))
      hrAfterCampi.style.display = "";
  }

  // Rinumerazione titoli sezioni (solo visuale) per B:
  // 1 Selezione, 2 Dati generali, 3 Allegati PDF, 4 Riepilogo, 5 Invio Allegati
  if(pdfTitleH3) pdfTitleH3.textContent = isB ? "3. Allegati PDF" : "4. Allegati PDF";
  if(riepilogoTitleH3) riepilogoTitleH3.textContent = isB ? "4. Riepilogo" : "5. Riepilogo";
  if(invioTitleH3) invioTitleH3.textContent = isB ? "5. Invio Allegati" : "6. Invio Allegati";
}


// Lista persistente di PDF accodati
let attachedPdfs = [];

const summaryChips = el("summaryChips");
const allegatoHint = el("allegatoHint");

const STORAGE_KEY = "unipa_centri_allegati_v1";

function setTheme(theme){
  document.body.setAttribute("data-theme", theme);
  el("btnTheme").textContent = "Tema: " + (theme==="light" ? "Chiaro (UniPA)" : "Scuro");
}
el("btnTheme").addEventListener("click", ()=>{
  const cur = document.body.getAttribute("data-theme") || "dark";
  setTheme(cur==="dark" ? "light" : "dark");
});

function populateAllegati(){
  const c = tipoCentroEl.value;
  allegatoEl.innerHTML = "";
  dynEl.innerHTML = `<div class="hint">Seleziona un Allegato per iniziare la compilazione.</div>`;
  if(!c){
    allegatoEl.disabled = true;
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "— Seleziona prima il tipo di centro —";
    allegatoEl.appendChild(opt);
    updatePdfRequirements();
    updateStatus();
    updateSummary();
    return;
  }
  allegatoEl.disabled = false;
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "— Seleziona —";
  allegatoEl.appendChild(opt0);

  const allowed = CENTRI[c].allegati;
  for(const k of allowed){
    const a = ALLEGATI[k];
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = `${k} – ${a.title.replace(/^Allegato\\s+[A-Z]\\s+–\\s+/,'')}`;
    allegatoEl.appendChild(opt);
  }
  allegatoHint.textContent = `Allegati disponibili per: ${CENTRI[c].label}.`;
  updatePdfRequirements();
  updatePdfRequirements();
  updateStatus();
  updateSummary();
}

tipoCentroEl.addEventListener("change", ()=>{
  populateAllegati();
});

allegatoEl.addEventListener("change", ()=>{
  renderFields();
  if(allegatoEl.value === "C"){
    alert("Da inviare almeno tre mesi prima della scadenza");
  }
  updatePdfRequirements();
  updateStatus();
  updateSummary();
});

function updateStatus(msg){
  const c = tipoCentroEl.value;
  const a = allegatoEl.value;
  if(msg){
    statusBox.className = "status err";
    statusBox.textContent = msg;
    return;
  }
  if(!c){
    statusBox.className = "status";
    statusBox.textContent = "In attesa di selezioni…";
    return;
  }
  if(!a){
    statusBox.className = "status";
    statusBox.textContent = "Seleziona un Allegato…";
    return;
  }
  statusBox.className = "status ok";
  statusBox.textContent = "Pronto per compilazione.";
}

function updateSummary(){
  const c = tipoCentroEl.value;
  const a = allegatoEl.value;

  const cLabel = c ? CENTRI[c].label : "—";
  const aLabel = a ? ALLEGATI[a].title : "—";

  summaryChips.innerHTML = `
    <div class="chip"><strong>Centro:</strong> ${escapeHtml(cLabel)}</div>
    <div class="chip"><strong>Allegato:</strong> ${escapeHtml(aLabel)}</div>
    <div class="chip"><strong>File PDF:</strong> ${getSelectedFiles().length}</div>
  `;
}


function updatePdfRequirements(){
  const aKey = allegatoEl.value;

  // layout e rinumerazione (solo UI) per Allegato B
  applySectionLayoutForAllegato();

  // Avviso requisiti PDF: per A, B ed E
  if(aKey === "A" || aKey === "B" || aKey === "C" || aKey === "E"){
    if(requiredPdfInfo){
      requiredPdfInfo.style.display = "block";
    }
  } else {
    if(requiredPdfInfo){
      requiredPdfInfo.style.display = "none";
    }
  }

  // Testo dinamico requisiti
  if(aKey === "A"){
    requiredPdfInfo.innerHTML = `
      <strong>Per l’Allegato A sono obbligatori almeno 2 PDF:</strong><br>
      • Bozza della convenzione ai sensi dell'Art. 8 del Regolamento sui Centri<br>
      • Estratto verbale/i Consiglio/i di Dipartimento ai sensi dell'Art. 4 comma 2 lettera g del Regolamento sui Centri
    `;
  }

  if(aKey === "B"){
    requiredPdfInfo.innerHTML = `
      <strong>Per l’Allegato B sono obbligatori almeno 2 PDF:</strong><br>
      • Bozza della Convenzione ai sensi dell'art. 5 del Regolamento<br>
      • Estratto del verbale del Consiglio di Dipartimento dei Dipartimenti coinvolti
    `;
  }

  if(aKey === "C"){
    requiredPdfInfo.innerHTML = `
      <strong>Per l’Allegato C sono obbligatori almeno 4 PDF:</strong><br>
      • Atto di Rinnovo della Convenzione<br>
      • Riepilogo, anche in forma di relazione, delle attività svolte nel precedente periodo di rinnovo: risultati delle attività svolte /eventuali finanziamenti ricevuti/stato di avanzamento dei progetti<br>
      • Programma delle attività previste per il periodo di rinnovo<br>
      • Estratto del verbale del Consiglio di Dipartimento dei Dipartimenti coinvolti presso Unipa
    `;
  }

  
  if(aKey === "E"){
    requiredPdfInfo.innerHTML = `
      <strong>Per l’Allegato E sono obbligatori almeno 4 PDF:</strong><br>
      • Programma, anche in forma di relazione, delle attività previste per il periodo individuato<br>
      • Estratto verbale/i Consiglio/i di Dipartimento ai sensi dell'art. 13 comma 2 lettera f<br>
      • Delibera del Consiglio di Dipartimento di accettazione della sede amministrativa<br>
      • Bozza del Regolamento di funzionamento ai sensi dell'art. 18 del Regolamento sui Centri
    `;
  }

}


function renderFields(){
  const k = allegatoEl.value;
  if(!k){
    dynEl.innerHTML = `<div class="hint">Seleziona un Allegato per iniziare la compilazione.</div>`;
    return;
  }
  const model = ALLEGATI[k];
  const frag = document.createDocumentFragment();

  const head = document.createElement("div");
  head.className = "warn";
  head.innerHTML = `<strong>${escapeHtml(model.title)}</strong><br>
                    Compila i campi pertinenti e carica i PDF richiesti nella sezione “Allegati PDF”.`;
  frag.appendChild(head);

  const container = document.createElement("div");
  container.style.marginTop = "12px";

  for(const f of model.fields){
    const row = document.createElement("div");
    row.className = "row";

    const lab = document.createElement("label");
    lab.setAttribute("for", "f_"+f.id);
    lab.textContent = (f.required ? "• " : "") + f.label;
    row.appendChild(lab);

    const box = document.createElement("div");
    let input;

    if(f.type === "textarea"){
      input = document.createElement("textarea");
      input.placeholder = "Inserisci testo…";
    } else if(f.type === "number"){
      input = document.createElement("input");
      input.type = "number";
      input.placeholder = "Es. 3";
      if(Number.isFinite(f.min)) input.min = String(f.min);
      if(Number.isFinite(f.max)) input.max = String(f.max);
    } else if(f.type === "select"){
      input = document.createElement("select");
      for(const opt of f.options){
        const o = document.createElement("option");
        o.value = opt.v;
        o.textContent = opt.t;
        input.appendChild(o);
      }
    } else {
      input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Inserisci…";
    }

    input.id = "f_"+f.id;
    input.dataset.fieldId = f.id;
    input.dataset.required = f.required ? "1" : "0";
    input.addEventListener("input", updateSummary);

    box.appendChild(input);

    const hint = document.createElement("div");
    hint.className = "hint";
    hint.textContent = f.required ? "Obbligatorio." : "Facoltativo.";
    box.appendChild(hint);

    row.appendChild(box);
    container.appendChild(row);
  }

  frag.appendChild(container);
  dynEl.innerHTML = "";
  dynEl.appendChild(frag);
}

/* ===== Allegati PDF: accoda più file anche in momenti diversi ===== */
btnAddFiles.addEventListener("click", ()=> {
  fileUploads.click();
});

btnClearFiles.addEventListener("click", ()=> {
  attachedPdfs = [];
  fileUploads.value = "";
  renderFileList();
  updateSummary();
  updateStatus();
});

fileUploads.addEventListener("change", ()=>{
  const files = Array.from(fileUploads.files || []);
  if(!files.length) return;

  const bad = files.filter(f => !(f.type === "application/pdf" || f.name.toLowerCase().endsWith(".pdf")));
  if(bad.length){
    updateStatus("Caricamento rifiutato: sono ammessi solo file PDF.");
    fileUploads.value = "";
    return;
  }

  for(const f of files){
    const dup = attachedPdfs.some(x => x.name === f.name && x.size === f.size);
    if(!dup) attachedPdfs.push(f);
  }

  fileUploads.value = ""; // consente aggiunte successive anche dello stesso file (se necessario)

  renderFileList();
  updateSummary();
  updateStatus();
});

function renderFileList(){
  if(!attachedPdfs.length){
    fileList.textContent = "Nessun file caricato.";
    return;
  }

  fileList.innerHTML = attachedPdfs.map((f,i)=> `
    <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid var(--border);">
      <div style="min-width:0;">
        <div style="font-size:12px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          ${i+1}. ${escapeHtml(f.name)}
        </div>
        <div style="font-size:12px; color:var(--muted);">${formatBytes(f.size)}</div>
      </div>
      <button type="button" class="btn-danger" style="padding:8px 10px; border-radius:10px;" onclick="removePdfAt(${i})">Rimuovi</button>
    </div>
  `).join("");
}

window.removePdfAt = function(idx){
  attachedPdfs.splice(idx, 1);
  renderFileList();
  updateSummary();
};

function getSelectedFiles(){
  return attachedPdfs.slice();
}
/* ===== Fine Allegati PDF ===== */

el("btnSave").addEventListener("click", ()=>{
  const payload = collectState();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  statusBox.className = "status ok";
  statusBox.textContent = "Bozza salvata.";
});

el("btnLoad").addEventListener("click", ()=>{
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){
    updateStatus("Nessuna bozza trovata nel browser.");
    return;
  }
  try{
    const payload = JSON.parse(raw);
    applyState(payload);
    statusBox.className = "status ok";
    statusBox.textContent = "Bozza recuperata.";
  } catch(e){
    updateStatus("Bozza non leggibile (JSON corrotto).");
  }
});

el("btnClear").addEventListener("click", ()=>{
  tipoCentroEl.value = "";
  populateAllegati();
  el("protocollo").value = "";
  el("dataCompilazione").value = "";
  el("noteGenerali").value = "";

  attachedPdfs = [];
  fileUploads.value = "";
  renderFileList();

  updatePdfRequirements();
  updateStatus();
  updateSummary();
});

el("btnPDF").addEventListener("click", async ()=>{
  try{
    const c = tipoCentroEl.value;
    const aKey = allegatoEl.value;
    if(!c){ updateStatus("Seleziona il tipo di centro."); return; }
    if(!aKey){ updateStatus("Seleziona un Allegato."); return; }

    const missing = [];
    const model = ALLEGATI[aKey];

    // Per Allegato B: la sezione "Campi Allegato selezionato" è rimossa, quindi non validiamo i campi.
    if(aKey !== "B"){
      for(const f of model.fields){
        if(!f.required) continue;
        const node = document.getElementById("f_"+f.id);
        if(!node) continue;
        const v = (node.value || "").trim();
        if(!v) missing.push(f.label);

        if(f.type==="number" && v){
          const n = Number(v);
          if(Number.isFinite(f.min) && n < f.min) missing.push(`${f.label} (min ${f.min})`);
          if(Number.isFinite(f.max) && n > f.max) missing.push(`${f.label} (max ${f.max})`);
        }
      }
      if(missing.length){
        updateStatus("Compilazione incompleta: verifica i campi obbligatori.");
        alert("Mancano/sono non validi i seguenti campi obbligatori:\n\n- " + missing.join("\n- "));
        return;
      }
    }

    const files = getSelectedFiles();
    if(PDF_REQUIREMENTS[aKey]){
      const minReq = PDF_REQUIREMENTS[aKey].min;
      if(files.length < minReq){
        updateStatus(`Per l’Allegato ${aKey} caricare almeno ${minReq} PDF obbligatori.`);
        alert(
          `Per l’Allegato ${aKey} sono obbligatori almeno ${minReq} PDF:\n\n- ` +
          PDF_REQUIREMENTS[aKey].items.join("\n- ")
        );
        return;
      }
    }
    const bad = files.filter(f => !(f.type === "application/pdf" || f.name.toLowerCase().endsWith(".pdf")));
    if(bad.length){ updateStatus("Caricamento rifiutato: sono ammessi solo file PDF."); return; }

    statusBox.className = "status";
    statusBox.textContent = "Generazione PDF in corso…";

    const pdfBytes = await buildMergedPdf();
    const nameSafe = sanitizeFilename(`Allegato_${aKey}_Centri_UNIPA_${todayYMD()}.pdf`);
    downloadBytes(pdfBytes, nameSafe);

    statusBox.className = "status ok";
    statusBox.textContent = "PDF generato.";
  } catch(err){
    console.error(err);
    updateStatus("Errore in generazione PDF. Vedi console.");
    alert("Errore durante la generazione del PDF.\n\nDettagli: " + (err?.message || String(err)));
  }
});

async function buildMergedPdf(){
  const { PDFDocument, StandardFonts, rgb } = PDFLib;

  const c = tipoCentroEl.value;
  const aKey = allegatoEl.value;
  const model = ALLEGATI[aKey];

  const outPdf = await PDFDocument.create();
  outPdf.setTitle(model.title);

  const font = await outPdf.embedFont(StandardFonts.Helvetica);
  const fontBold = await outPdf.embedFont(StandardFonts.HelveticaBold);

  const margin = 44;
  const pageW = 595.28;
  const pageH = 841.89;

  function addPage(){ return outPdf.addPage([pageW, pageH]); }

  function drawWrapped(page, text, x, y, maxWidth, size=11, bold=false){
    const f = bold ? fontBold : font;
    const words = String(text || "").split(/\s+/).filter(Boolean);
    const lines = [];
    let cur = "";
    const widthOf = (s)=> f.widthOfTextAtSize(s, size);

    for(const w of words){
      const test = cur ? (cur + " " + w) : w;
      if(widthOf(test) <= maxWidth){
        cur = test;
      } else {
        if(cur) lines.push(cur);
        cur = w;
      }
    }
    if(cur) lines.push(cur);

    for(const ln of lines){
      page.drawText(ln, { x, y, size, font:f, color: rgb(0,0,0) });
      y -= (size + 3);
    }
    return y;
  }

  let page = addPage();
  let y = pageH - margin;

  page.drawText("Università degli Studi di Palermo", { x: margin, y, size: 12, font: fontBold, color: rgb(0,0,0) });
  y -= 18;
  y = drawWrapped(page, "Riepilogo pratica", margin, y, pageW - margin*2, 16, true);
  y -= 8;

  const protocollo = el("protocollo").value.trim();
  const dataComp = el("dataCompilazione").value;
  const noteGen = el("noteGenerali").value.trim();

  y = drawWrapped(page, `Tipo di centro: ${CENTRI[c].label}`, margin, y, pageW - margin*2, 12, true);
  y = drawWrapped(page, `Allegato: ${model.title}`, margin, y, pageW - margin*2, 11, true);
  y -= 6;
  if(protocollo) y = drawWrapped(page, `Referente per il Centro: ${protocollo}`, margin, y, pageW - margin*2, 11, false);
  if(dataComp) y = drawWrapped(page, `Data compilazione: ${dataComp}`, margin, y, pageW - margin*2, 11, false);
  y -= 8;

  if(noteGen){
    y = drawWrapped(page, "Note generali:", margin, y, pageW - margin*2, 11, true);
    y = drawWrapped(page, noteGen, margin, y, pageW - margin*2, 11, false);
    y -= 6;
  }

  y -= 6;

  if(aKey !== "B"){
    y = drawWrapped(page, "Dati Allegato:", margin, y, pageW - margin*2, 12, true);
    y -= 4;

    for(const f of model.fields){
      const node = document.getElementById("f_"+f.id);
      const v = node ? (node.value || "").trim() : "";
      const label = f.label + (f.required ? " (obbl.)" : "");
      y = drawWrapped(page, label, margin, y, pageW - margin*2, 10, true);
      y = drawWrapped(page, v || "—", margin, y, pageW - margin*2, 10, false);
      y -= 6;
      if(y < 90){
        page = addPage();
        y = pageH - margin;
      }
    }
  } else {
    y = drawWrapped(page, "Dati Allegato:", margin, y, pageW - margin*2, 12, true);
    y = drawWrapped(page, "Per l’Allegato B non è prevista la compilazione dei campi: caricare i PDF obbligatori.", margin, y, pageW - margin*2, 11, false);
    y -= 6;
  }

  const files = getSelectedFiles();
  y -= 4;
  y = drawWrapped(page, `Allegati PDF caricati: ${files.length}`, margin, y, pageW - margin*2, 12, true);

  if(PDF_REQUIREMENTS[aKey]){
    y = drawWrapped(page, `Requisito Allegato ${aKey}: almeno ${PDF_REQUIREMENTS[aKey].min} PDF obbligatori:`, margin, y, pageW - margin*2, 11, true);
    for(const item of (PDF_REQUIREMENTS[aKey]?.items || [])){
      y = drawWrapped(page, `• ${item}`, margin, y, pageW - margin*2, 10, false);
      if(y < 80){
        page = addPage();
        y = pageH - margin;
      }
    }
    y -= 6;
  }

  if(files.length){
    for(const f of files){
      y = drawWrapped(page, `- ${f.name} (${formatBytes(f.size)})`, margin, y, pageW - margin*2, 10, false);
      if(y < 80){
        page = addPage();
        y = pageH - margin;
      }
    }
  } else {
    y = drawWrapped(page, "Nessun file PDF caricato.", margin, y, pageW - margin*2, 10, false);
  }

  y -= 10;
  const invioLabel = (aKey === "B") ? "5. Invio Allegati" : "6. Invio Allegati";
  y = drawWrapped(page, invioLabel, margin, y, pageW - margin*2, 12, true);
  y = drawWrapped(page, "il file PDF generato va inviato ..........", margin, y, pageW - margin*2, 11, false);

  for(const f of files){
    const ab = await f.arrayBuffer();
    const src = await PDFDocument.load(ab);
    const copied = await outPdf.copyPages(src, src.getPageIndices());
    for(const p of copied){
      outPdf.addPage(p);
    }
  }

  return await outPdf.save();
}

function collectState(){
  const state = {
    tipoCentro: tipoCentroEl.value,
    allegato: allegatoEl.value,
    protocollo: el("protocollo").value,
    dataCompilazione: el("dataCompilazione").value,
    noteGenerali: el("noteGenerali").value,
    fields: {}
  };
  const aKey = allegatoEl.value;
  if(aKey){
    const model = ALLEGATI[aKey];
    for(const f of model.fields){
      const node = document.getElementById("f_"+f.id);
      if(node) state.fields[f.id] = node.value;
    }
  }
  return state;
}

function applyState(state){
  tipoCentroEl.value = state.tipoCentro || "";
  populateAllegati();
  allegatoEl.value = state.allegato || "";
  renderFields();

  el("protocollo").value = state.protocollo || "";
  el("dataCompilazione").value = state.dataCompilazione || "";
  el("noteGenerali").value = state.noteGenerali || "";

  const aKey = allegatoEl.value;
  if(aKey && state.fields){
    const model = ALLEGATI[aKey];
    for(const f of model.fields){
      const node = document.getElementById("f_"+f.id);
      if(node && (f.id in state.fields)) node.value = state.fields[f.id] ?? "";
    }
  }
  updateStatus();
  updateSummary();
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function formatBytes(bytes){
  const b = Number(bytes || 0);
  if(b < 1024) return b + " B";
  const kb = b/1024;
  if(kb < 1024) return kb.toFixed(1) + " KB";
  const mb = kb/1024;
  return mb.toFixed(1) + " MB";
}

function downloadBytes(bytes, filename){
  const blob = new Blob([bytes], { type:"application/pdf" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function sanitizeFilename(name){
  return name.replace(/[\\/:*?"<>|]+/g, "_").replace(/\s+/g, "_").slice(0, 140);
}
function todayYMD(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
}

(function init(){
  el("dataCompilazione").value = todayYMD();
  setTheme("light");

  el("protocollo").addEventListener("input", updateSummary);
  el("dataCompilazione").addEventListener("input", updateSummary);
  el("noteGenerali").addEventListener("input", updateSummary);

  populateAllegati();
  updatePdfRequirements();
  updateSummary();
  renderFileList();
})();
</script>
</body>
</html>
